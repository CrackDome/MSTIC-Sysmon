<Sysmon schemaversion="4.22">
  <HashAlgorithms>md5,sha256,IMPHASH</HashAlgorithms>
  <EventFiltering>
    <RuleGroup name="" groupRelation="or">
      <ProcessCreate onmatch="exclude">
        <Rule name="" groupRelation="or">
          <CommandLine condition="begin with">sh -c /opt/omi/bin/omicli </CommandLine>
          <Image condition="is">/opt/omi/bin/omicli</Image>
          <Image condition="is">/opt/microsoft/auoms/bin/auomsctl</Image>
          <CommandLine condition="is">grep =</CommandLine>
          <CommandLine condition="is">pgrep -U omsagent omiagent</CommandLine>
          <Image condition="is">/usr/sbin/logrotate</Image>
          <ParentImage condition="is">/opt/microsoft/auoms/bin/auomsctl</ParentImage>
          <ParentImage condition="is">/opt/microsoft/omsagent/ruby/bin/ruby</ParentImage>
          <ParentImage condition="is">/usr/local/qualys/command-agent/bin/scan_manifest</ParentImage>
          <CommandLine condition="is">/bin/sh -c [ -f /etc/krb5.keytab ] &amp;&amp; [ \( ! -f /etc/opt/omi/creds/omi.keytab \) -o \( /etc/krb5.keytab -nt /etc/opt/omi/creds/omi.keyta
				b \) ] &amp;&amp; /opt/omi/bin/support/ktstrip /etc/krb5.keytab /etc/opt/omi/creds/omi.keytab &gt;/dev/null 2&gt;&amp;1 || true</CommandLine>
        </Rule>
        <Rule name="DNSIptablesVersion" groupRelation="and">
          <ParentImage condition="is">/usr/bin/python3.6</ParentImage>
          <CommandLine condition="is">iptables --version</CommandLine>
        </Rule>
        <Rule name="DNSIptablesSet" groupRelation="and">
          <ParentImage condition="is">/usr/bin/python3.6</ParentImage>
          <CommandLine condition="is">iptables -t security -C OUTPUT -d 168.63.129.16 -p tcp -m conntrack --ctstate INVALID,NEW -j DROP -w</CommandLine>
        </Rule>
        <Rule name="OmsagentPython" groupRelation="and">
          <User condition="is">omsagent</User>
          <ParentImage condition="is">/usr/bin/python2.7</ParentImage>
        </Rule>
        <Rule name="AgentXtables" groupRelation="and">
          <Image condition="is">/sbin/xtables-multi</Image>
          <CurrentDirectory condition="begin with">/var/lib/waagent/</CurrentDirectory>
        </Rule>
        <Rule name="OmsagentDir" groupRelation="and">
          <User condition="is">omsagent</User>
          <CurrentDirectory condition="begin with">/var/opt/microsoft/omsagent/</CurrentDirectory>
        </Rule>
        <Rule name="OmsagentScriptDir" groupRelation="and">
          <User condition="is">omsagent</User>
          <CurrentDirectory condition="begin with">/opt/microsoft/omsconfig/Scripts/</CurrentDirectory>
        </Rule>
      </ProcessCreate>
    </RuleGroup>
  </EventFiltering>
</Sysmon>